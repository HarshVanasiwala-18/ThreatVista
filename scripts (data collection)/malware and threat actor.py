import requests
import json
from bs4 import BeautifulSoup
import os

def scrape_malware_family():
    data = []
    i = 1
    while i <= 32:
        try:
            response = requests.get(f"https://malpedia.caad.fkie.fraunhofer.de/families/{i}/")
            if response.status_code == 200:
                soup = BeautifulSoup(response.text, "html.parser")

                find_table = soup.find(
                    "table", {"class": "table enumerated table-dark table-sm"}
                )

                i += 1

                for row in find_table.find_all("tr"):
                    malware_family = row.find("td", class_="common_name")
                    threat_actor = row.find("td", class_="actors")
                    alt_names = row.find("td", class_="alt_names")
                    name = row.find("td", class_="name")

                    malware_family_text = (
                        malware_family.text
                        if malware_family and malware_family.text
                        else None
                    )

                    threat_actor_text = (
                        threat_actor.text if threat_actor and threat_actor.text else None
                    )
                    alt_names_text = (
                        alt_names.text if alt_names and alt_names.text else None
                    )
                    name_text = name.text if name and name.text else None

                    if malware_family_text == "[]":
                        malware_family_text = None

                    if threat_actor_text and threat_actor_text != "[]":
                        threat_actor_text = (
                            threat_actor_text.replace("[", "")
                            .replace("]", "")
                            .replace("'", "")
                        )
                    else:
                        threat_actor_text = None

                    if alt_names_text and alt_names_text != "[]":
                        alt_names_text = (
                            alt_names_text.replace("[", "")
                            .replace("]", "")
                            .replace("'", "")
                        )
                    else:
                        alt_names_text = None

                    if name_text == "[]":
                        name_text = None

                    entry = {
                        "Malware Family": str(malware_family_text).strip(),
                        "Threat Actor": threat_actor_text,
                        "Aliases": alt_names_text,
                        "Name": name_text,
                    }

                    data.append(entry)
        except Exception as e:
            print("Exception:", e)

    with open("malware_families.json", "w") as file:
        json.dump(data, file, indent=4)

def scrape_threat_actor():
    try:
        response = requests.get("https://malpedia.caad.fkie.fraunhofer.de/actors")
        if response.status_code == 200:
            soup = BeautifulSoup(response.text, "html.parser")

            find_table = soup.find("table", {"class": "table enumerated table-dark table-sm"})

            data = []

            for row in find_table.find_all("tr", class_="clickable-row"):
                threat_actor = row.find("td", class_="common_name")
                aliases = row.find("td", class_="synonyms")

                threat_actor_text = threat_actor.text.strip() if threat_actor and threat_actor.text else None
                aliases_text = aliases.text.strip() if aliases and aliases.text else None
                
                entry = {
                    "Threat Actor": threat_actor_text,
                    "Aliases": aliases_text,
                }

                data.append(entry)

            with open("threat_actors.json", "w") as file:
                json.dump(data, file, indent=4)

    except Exception as e:
        print("Exception:", e)